<!DOCTYPE html>
// DOM Elements
        const notLoggedInEl = document.getElementById('not-logged-in');
        const quizAppEl = document.getElementById('quiz-app');
        const selectionScreen = document.getElementById('selection-screen');
        const quizContainer = document.getElementById('quiz-container');
        const topicsPanel = document.getElementById('topics-panel');
        const levelsPanel = document.getElementById('levels-panel');
        const functionsGrid = document.getElementById('functions-grid');
        const conceptsGrid = document.getElementById('concepts-grid');
        const levelsGrid = document.getElementById('levels-grid');
        const modeTabs = document.querySelectorAll('.tab');
        const startBtn = document.getElementById('start-btn');
        const nextBtn = document.getElementById('next-btn');
        const backBtn = document.getElementById('back-btn');
        const selectionsText = document.getElementById('selections-summary');
        const quizModeDisplay = document.getElementById('quiz-mode-display');
        const levelNameEl = document.getElementById('level-name');
        const levelDescEl = document.getElementById('level-description');
        const questionEl = document.getElementById('question');
        const optionsEl = document.getElementById('options');
        const progressBarEl = document.getElementById('progress-bar');
        const scoreEl = document.querySelector('#score .stat-value');
        const xpEl = document.querySelector('#xp .stat-value');
        const livesEl = document.querySelector('#lives .stat-value');
        const correctCountEl = document.getElementById('correct-count');
        const wrongCountEl = document.getElementById('wrong-count');
        const streakCountEl = document.getElementById('streak-count');
        const questionNumberEl = document.getElementById('question-number');
        const totalQuestionsEl = document.getElementById('total-questions');
        const notificationEl = document.getElementById('notification');
        const userAvatarEl = document.getElementById('user-avatar');
        const userNameEl = document.getElementById('user-name');
        const logoutBtn = document.getElementById('logout-btn');

        // Quiz state
        let selectedMode = "topics"; // "topics" or "levels"
        let selectedTopics = [];
        let selectedLevels = [];
        let filteredQuestions = [];
        let currentQuestionIndex = 0;
        let score = 0;
        let xp = 0;
        let lives = 3;
        let streak = 0;
        let correctCount = 0;
        let wrongCount = 0;
        let questionsAnswered = false;
        let currentUser = null;

        // Check login status
        function checkLoginStatus() {
            const userStr = localStorage.getItem('user');
            if (!userStr) {
                notLoggedInEl.classList.remove('hidden');
                quizAppEl.classList.add('hidden');
                return false;
            }

            try {
                currentUser = JSON.parse(userStr);
                
                // Update user info
                userNameEl.textContent = currentUser.username;
                userAvatarEl.textContent = currentUser.username.charAt(0).toUpperCase();
                
                // Initialize stats from user data
                score = currentUser.total_score || 0;
                lives = currentUser.hearts || 3;
                streak = currentUser.streak || 0;
                xp = currentUser.xp || 0;
                
                // Update UI
                scoreEl.textContent = score;
                livesEl.textContent = lives;
                streakCountEl.textContent = streak;
                xpEl.textContent = xp;
                
                notLoggedInEl.classList.add('hidden');
                quizAppEl.classList.remove('hidden');
                return true;
            } catch (error) {
                console.error('Error parsing user data:', error);
                notLoggedInEl.classList.remove('hidden');
                quizAppEl.classList.add('hidden');
                return false;
            }
        }

        // Helper functions
        function showNotification(message, type) {
            notificationEl.textContent = message;
            notificationEl.className = `notification-${type}`;
            notificationEl.classList.add('show');

            setTimeout(() => {
                notificationEl.classList.remove('show');
            }, 3000);
        }

        // Get unique topics categorized by type
        function getCategorizedTopics() {
            const functionTopics = new Set();
            const conceptTopics = new Set();

            allQuestions.forEach(question => {
                question.topics.forEach(topic => {
                    if (topic === 'function' || topic.includes('()')) {
                        // This is a function
                    } else if (question.topics.includes('function') && topic !== 'function') {
                        functionTopics.add(topic);
                    } else {
                        conceptTopics.add(topic);
                    }
                });
            });

            return {
                functions: Array.from(functionTopics).sort(),
                concepts: Array.from(conceptTopics).sort()
            };
        }

        // Count questions for each topic
        function countQuestionsPerTopic() {
            const topicCounts = {};

            allQuestions.forEach(question => {
                question.topics.forEach(topic => {
                    if (!topicCounts[topic]) {
                        topicCounts[topic] = 0;
                    }
                    topicCounts[topic]++;
                });
            });

            return topicCounts;
        }

        // Count questions for each level
        function countQuestionsPerLevel() {
            const levelCounts = {};

            Object.keys(questionsByLevel).forEach(level => {
                levelCounts[level] = questionsByLevel[level].length;
            });

            return levelCounts;
        }

        // Initialize selection screen for topics
        function initTopicSelection() {
            const categorizedTopics = getCategorizedTopics();
            const topicCounts = countQuestionsPerTopic();

            // Add function topics
            functionsGrid.innerHTML = '';
            categorizedTopics.functions.forEach(topic => {
                const count = topicCounts[topic] || 0;
                const topicElement = document.createElement('div');
                topicElement.className = 'topic-item';
                topicElement.dataset.topic = topic;
                topicElement.innerHTML = `
                    ${topic}()
                    <span class="topic-badge">${count}</span>
                `;

                topicElement.addEventListener('click', () => {
                    topicElement.classList.toggle('selected');

                    if (topicElement.classList.contains('selected')) {
                        if (!selectedTopics.includes(topic)) {
                            selectedTopics.push(topic);
                        }
                    } else {
                        selectedTopics = selectedTopics.filter(t => t !== topic);
                    }

                    updateSelectionSummary();
                });

                functionsGrid.appendChild(topicElement);
            });

            // Add concept topics
            conceptsGrid.innerHTML = '';
            categorizedTopics.concepts.forEach(topic => {
                const count = topicCounts[topic] || 0;
                const topicElement = document.createElement('div');
                topicElement.className = 'topic-item';
                topicElement.dataset.topic = topic;
                topicElement.innerHTML = `
                    ${topic.charAt(0).toUpperCase() + topic.slice(1)}
                    <span class="topic-badge">${count}</span>
                `;

                topicElement.addEventListener('click', () => {
                    topicElement.classList.toggle('selected');

                    if (topicElement.classList.contains('selected')) {
                        if (!selectedTopics.includes(topic)) {
                            selectedTopics.push(topic);
                        }
                    } else {
                        selectedTopics = selectedTopics.filter(t => t !== topic);
                    }

                    updateSelectionSummary();
                });

                conceptsGrid.appendChild(topicElement);
            });
        }

        // Initialize selection screen for levels
        function initLevelSelection() {
            const levelCounts = countQuestionsPerLevel();

            levelsGrid.innerHTML = '';

            levels.forEach(level => {
                const count = levelCounts[level.id] || 0;

                const levelCard = document.createElement('div');
                levelCard.className = 'level-card';
                levelCard.dataset.level = level.id;

                // Create header
                const header = document.createElement('div');
                header.className = 'level-header';
                header.style.background = level.color;
                header.innerHTML = `
                    <div class="level-title">${level.title}</div>
                    <div class="level-count">${count} Questions</div>
                `;

                // Create description
                const desc = document.createElement('div');
                desc.className = 'level-desc';
                desc.textContent = level.description;

                // Create topics list
                const topicsList = document.createElement('div');
                topicsList.className = 'level-topics';

                level.topics.forEach(topic => {
                    const topicEl = document.createElement('div');
                    topicEl.className = 'level-topic';
                    topicEl.textContent = topic;
                    topicsList.appendChild(topicEl);
                });

                // Append all to card
                levelCard.appendChild(header);
                levelCard.appendChild(desc);
                levelCard.appendChild(topicsList);

                // Add click handler
                levelCard.addEventListener('click', () => {
                    // Toggle selection
                    levelCard.classList.toggle('selected');

                    const levelId = parseInt(levelCard.dataset.level);

                    if (levelCard.classList.contains('selected')) {
                        // Add to selected levels if not already there
                        if (!selectedLevels.includes(levelId)) {
                            selectedLevels.push(levelId);
                        }
                    } else {
                        // Remove from selected levels
                        selectedLevels = selectedLevels.filter(l => l !== levelId);
                    }

                    updateSelectionSummary();
                });

                levelsGrid.appendChild(levelCard);
            });
        }

        // Update selection summary
        function updateSelectionSummary() {
            if (selectedMode === 'topics') {
                if (selectedTopics.length === 0) {
                    selectionsText.textContent = "Select at least one topic to practice";
                } else {
                    const formattedTopics = selectedTopics.map(t =>
                        t.includes('()') ? t : t.charAt(0).toUpperCase() + t.slice(1)
                    ).join(', ');

                    selectionsText.textContent = `Selected topics: ${formattedTopics}`;
                }
            } else { // levels mode
                if (selectedLevels.length === 0) {
                    selectionsText.textContent = "Select at least one level to practice";
                } else {
                    const levelNames = selectedLevels
                        .sort((a, b) => a - b)
                        .map(id => {
                            const level = levels.find(l => l.id === id);
                            return level ? level.title.split(':')[0] : `Level ${id}`;
                        })
                        .join(', ');

                    selectionsText.textContent = `Selected levels: ${levelNames}`;
                }
            }
        }

        // Filter questions based on selected topics
        function filterQuestionsByTopics() {
            if (selectedTopics.length === 0) {
                return allQuestions.slice(); // Return all questions if no topics selected
            }

            const filtered = allQuestions.filter(question =>
                question.topics.some(topic => selectedTopics.includes(topic))
            );

            // Remove duplicates
            const uniqueQuestions = [];
            const seenQuestions = new Set();

            filtered.forEach(question => {
                if (!seenQuestions.has(question.question)) {
                    seenQuestions.add(question.question);
                    uniqueQuestions.push(question);
                }
            });

            return uniqueQuestions;
        }

        // Filter questions based on selected levels
        function filterQuestionsByLevels() {
            if (selectedLevels.length === 0) {
                return allQuestions.slice(); // Return all questions if no levels selected
            }

            const filtered = [];

            selectedLevels.forEach(levelId => {
                if (questionsByLevel[levelId]) {
                    filtered.push(...questionsByLevel[levelId]);
                }
            });

            return filtered;
        }

        // Update quiz mode display
        function updateQuizModeDisplay() {
            quizModeDisplay.innerHTML = "";

            if (selectedMode === 'topics') {
                if (selectedTopics.length === 0) {
                    quizModeDisplay.innerHTML = "<span class='mode-badge'>All Topics</span>";
                } else {
                    const topicBadges = selectedTopics.map(topic =>
                        `<span class='mode-badge'>${topic}</span>`
                    ).join(" ");

                    quizModeDisplay.innerHTML = topicBadges;
                }
            } else { // levels mode
                if (selectedLevels.length === 0) {
                    quizModeDisplay.innerHTML = "<span class='mode-badge'>All Levels</span>";
                } else {
                    const levelBadges = selectedLevels
                        .sort((a, b) => a - b)
                        .map(id => {
                            const level = levels.find(l => l.id === id);
                            return `<span class='mode-badge'>${level ? level.title.split(':')[0] : `Level ${id}`}</span>`;
                        })
                        .join(" ");

                    quizModeDisplay.innerHTML = levelBadges;
                }
            }
        }

        // Load current question
        function loadQuestion() {
            if (currentQuestionIndex >= filteredQuestions.length) {
                // Reset to beginning if we've gone through all questions
                filteredQuestions.sort(() => Math.random() - 0.5);
                currentQuestionIndex = 0;
                showNotification("Great job! Starting a new set of questions.", "levelup");
            }

            const question = filteredQuestions[currentQuestionIndex];
            questionEl.textContent = question.question;

            // Update question count
            questionNumberEl.textContent = currentQuestionIndex + 1;
            totalQuestionsEl.textContent = filteredQuestions.length;

            // Update progress bar
            const progress = ((currentQuestionIndex) / filteredQuestions.length) * 100;
            progressBarEl.style.width = `${progress}%`;

            // Clear previous options
            optionsEl.innerHTML = '';

            // Shuffle options
            const shuffledOptions = [...question.options].sort(() => Math.random() - 0.5);

            // Create option buttons
            shuffledOptions.forEach(option => {
                const btn = document.createElement('button');
                btn.className = 'option';
                btn.textContent = option;

                btn.addEventListener('click', () => {
                    if (questionsAnswered) return; // Prevent multiple answers

                    questionsAnswered = true;

                    const allButtons = optionsEl.querySelectorAll('.option');
                    // Disable all buttons to prevent multiple selections
                    allButtons.forEach(b => b.disabled = true);

                    if (option === question.answer) {
                        // Correct answer
                        btn.classList.add('correct');
                        btn.innerHTML += '<span class="check">✓</span>';

                        // Update stats
                        correctCount++;
                        streak++;
                        wrongCount = Math.max(0, wrongCount - 1); // Reduce wrong count on correct answers

                        // Reward player
                        score += 10;
                        xp += 5;
                        scoreEl.textContent = score;
                        xpEl.textContent = xp;
                    } else {
                        // Wrong answer
                        btn.classList.add('incorrect');

                        // Show correct answer
                        allButtons.forEach(b => {
                            if (b.textContent === question.answer) {
                                b.classList.add('correct');
                                b.innerHTML += '<span class="check">✓</span>';
                            }
                        });

                        // Update stats
                        wrongCount++;
                        streak = 0;

                        // Lose life
                        lives--;
                        if (lives < 0) lives = 0;
                        livesEl.textContent = lives;

                        // Check if out of lives
                        if (lives === 0) {
                            setTimeout(() => {
                                showNotification("You've run out of hearts! Let's give you more to continue learning.", "leveldown");
                                lives = 3;
                                livesEl.textContent = lives;
                            }, 500);
                        }
                    }

                    // Update stats display
                    correctCountEl.textContent = correctCount;
                    wrongCountEl.textContent = wrongCount;
                    streakCountEl.textContent = streak;

                    // Update user progress in database if logged in
                    if (currentUser) {
                        updateUserProgress(question, option === question.answer);
                    }
                });

                optionsEl.appendChild(btn);
            });

            questionsAnswered = false;
        }

        // Update user progress in the database
        function updateUserProgress(question, isCorrect) {
            // Create a unique ID for the question
            const questionId = btoa(question.question).substring(0, 20); // Simple encoding for unique ID
            
            // Send progress to server
            fetch('/api/progress', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    userId: currentUser.id,
                    questionId: questionId,
                    correct: isCorrect,
                    score: score,
                    hearts: lives,
                    streak: streak,
                    xp: xp
                }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update local user data
                    currentUser.total_score = score;
                    currentUser.hearts = lives;
                    currentUser.streak = streak;
                    currentUser.xp = xp;
                    localStorage.setItem('user', JSON.stringify(currentUser));
                }
            })
            .catch(error => {
                console.error('Error updating progress:', error);
            });
        }

        // Start quiz with selected topics/levels
        function startQuiz() {
            // Filter questions based on selected mode
            if (selectedMode === 'topics') {
                filteredQuestions = filterQuestionsByTopics();
            } else { // levels mode
                filteredQuestions = filterQuestionsByLevels();
            }

            if (filteredQuestions.length === 0) {
                showNotification(`No questions match your selection. Please try different ${selectedMode}.`, "leveldown");
                return;
            }

            // Shuffle questions
            filteredQuestions.sort(() => Math.random() - 0.5);

            // Reset quiz state
            currentQuestionIndex = 0;

            updateQuizModeDisplay();

            // Update quiz description
            if (selectedMode === 'topics') {
                if (selectedTopics.length === 0) {
                    levelNameEl.innerHTML = 'Python Practice <span class="level-badge">All Topics</span>';
                    levelDescEl.textContent = "Practice all Python topics";
                } else {
                    levelNameEl.innerHTML = 'Custom Practice <span class="level-badge">Selected Topics</span>';
                    levelDescEl.textContent = `Practice your selected Python topics`;
                }
            } else { // levels mode
                if (selectedLevels.length === 0) {
                    levelNameEl.innerHTML = 'Python Practice <span class="level-badge">All Levels</span>';
                    levelDescEl.textContent = "Practice questions from all levels";
                } else if (selectedLevels.length === 1) {
                    const level = levels.find(l => l.id === selectedLevels[0]);
                    levelNameEl.innerHTML = `${level.title} <span class="level-badge">Level ${level.id}</span>`;
                    levelDescEl.textContent = level.description;
                } else {
                    levelNameEl.innerHTML = 'Mixed Levels <span class="level-badge">Multiple</span>';
                    levelDescEl.textContent = "Practice questions from your selected levels";
                }
            }

            // Show quiz container
            selectionScreen.classList.add('hidden');
            quizContainer.classList.remove('hidden');

            // Load first question
            loadQuestion();
        }

        // Switch between topic and level selection modes
        function switchMode(mode) {
            selectedMode = mode;

            // Update UI
            modeTabs.forEach(tab => {
                if (tab.dataset.mode === mode) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });

            // Show/hide appropriate panels
            if (mode === 'topics') {
                topicsPanel.classList.remove('hidden');
                levelsPanel.classList.add('hidden');

                // Clear selected levels
                document.querySelectorAll('#levels-grid .level-card').forEach(card => {
                    card.classList.remove('selected');
                });
                selectedLevels = [];
            } else { // levels mode
                topicsPanel.classList.add('hidden');
                levelsPanel.classList.remove('hidden');

                // Clear selected topics
                document.querySelectorAll('.topic-item').forEach(item => {
                    item.classList.remove('selected');
                });
                selectedTopics = [];
            }

            updateSelectionSummary();
        }

        // Handle logout
        function handleLogout() {
            localStorage.removeItem('user');
            currentUser = null;
            window.location.href = '/index.html';
        }

        // Event Listeners
        // Mode tabs
        modeTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                switchMode(tab.dataset.mode);
            });
        });

        // Start button
        startBtn.addEventListener('click', () => {
            startQuiz();
        });

        // Next button
        nextBtn.addEventListener('click', () => {
            currentQuestionIndex++;
            loadQuestion();
        });

        // Back button
        backBtn.addEventListener('click', () => {
            quizContainer.classList.add('hidden');
            selectionScreen.classList.remove('hidden');
        });

        // Logout button
        logoutBtn.addEventListener('click', handleLogout);

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            if (checkLoginStatus()) {
                initTopicSelection();
                initLevelSelection();
                updateSelectionSummary();
            }
        });
    </script>
</body>
</html>
